<!doctype html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>MBTA Train Status</title>
	<meta name="author" content="Wendy">
    <style type="text/css">
        .triptitle {
            padding-left: .2em;
            padding-right: .2em;
        }

		.departuretime {
			display: none;
		}
		
		.trip {
		    border-color: #888888;
		    border-width: 1px;
		    border-bottom-width: 3px;
		    border-style: solid;
		    border-right-width: 3px;
			-webkit-border-radius: 6px;
			border-radius: 6px;
		    margin: .5em;
		    /* float: left; */
		}
		
		.tripTitle {
			background-color: lightgray;
			margin: 0px;
		}
		
		.destination {
			margin-left: .4em;
		}
        .vehicle {
			font-weight: normal;
			margin: 2px;
			margin-left: .7em;
			font-size: smaller;
        }

        .track {
            font-weight: normal;
            margin: 2px;
 			margin-left: .7em;
			font-size: smaller;
       }

		.tripnumber {
			font-weight: normal;
			margin: 2px;
			margin-left: .7em;
			font-size: smaller;
		}

    </style>

    <script type="text/javascript">

        var schedule_data = null;
        var departures_data = null;
		var myPage = new Object();
        myPage.trips = {};

        // triggered when we have jsonp with schedule data
        function grab_schedule(response) {
            schedule_data = response;
            format_page();
        }

        // triggered when departureboard data received
        function grab_departureboard(response) {
            departures_data = response;
            format_page();
        }

        // format the page with all the nice data we've gathered
        function format_page() {

            // run this only after both departures_data and schedule_data has been received
            if ((schedule_data == null) || (departures_data == null)) {
                return;
            }

            var messages = schedule_data.query.results.json.Messages;

            for (var i=0; i<messages.length; i++) {
                var trip = messages[i].Trip;
                if (!(trip in myPage.trips)) {
                    myPage.trips[trip] = new Object()
                    myPage.trips[trip].destination = messages[i].Destination
                    myPage.trips[trip].vehicle = messages[i].Vehicle
                    myPage.trips[trip].track = getTrack(trip);
                    myPage.trips[trip].stops = new Array()
                }

                nextIndex = myPage.trips[trip].stops.length
                myPage.trips[trip].stops[nextIndex] = new Object();
                myPage.trips[trip].stops[nextIndex].name = messages[i].Stop;
                myPage.trips[trip].stops[nextIndex].scheduled = new Date(messages[i].Scheduled*1000)
            }

            for (var index in myPage.trips) {
                //console.debug("trip: " + index + " " + myPage.trips[index].destination);

                var newTrip = document.createElement("div");
                id = "trip_" + index;
                newTrip.setAttribute("id", id);
                newTrip.setAttribute("class", "trip");
                document.getElementById("trips").appendChild(newTrip);
				
				// <h3> ... </h3>
                newTripTitle = document.createElement("h3");
                newTripTitle.setAttribute("id", id + "_title");
                newTripTitle.setAttribute("class", "tripTitle");

				// <span ..> 9:15 to: </span>  - if we have departure time
				departure_time = getDepartureTime(index);
				if (departure_time != "") {
					dep_time_element = document.createElement("span");
					dep_time_element.setAttribute("class", "departuretime");
					dep_time_element.innerText = formatTime(departure_time) + " to ";
					newTripTitle.appendChild(dep_time_element);
				} 

				// <span ..> Lowell </span>
                dest = document.createElement("span");
                dest.setAttribute("class", "destination");
                dest.innerText = myPage.trips[index].destination;
                newTripTitle.appendChild(dest);

                tripnumber = document.createElement("span");
                tripnumber.setAttribute("class", "tripnumber")
                tripnumber.innerText =  "Trip #" + index;
                newTripTitle.appendChild(tripnumber);

                vehicle = document.createElement("span");
                vehicle.setAttribute("class", "vehicle")
                vehicle.innerText =  "Vehicle #" + myPage.trips[index].vehicle;
                newTripTitle.appendChild(vehicle);

                if ((myPage.trips[index].track != null) && (myPage.trips[index].track != "")) {
                    track = document.createElement("span");
                    track.setAttribute("class", "track");
                    track.innerText = "Track #" + myPage.trips[index].track;
                    newTripTitle.appendChild(track);
                }
                newTrip.appendChild(newTripTitle);

                stopList = document.createElement("ul");
                stopList.setAttribute("class", "stoplist");
                newTrip.appendChild(stopList);

                for (var stop in myPage.trips[index].stops) {

                    newStop = document.createElement("li");
                    newStop.setAttribute("class", "stop");

                    // format the time
                    stime = myPage.trips[index].stops[stop].scheduled;
					st = formatTime(stime);
                    newStop.innerText = myPage.trips[index].stops[stop].name + ", scheduled for: " + st;

                    stopList.appendChild(newStop);
                }
            }
        }

		function formatTime(t) {
            min = t.getMinutes()
            if (min < 10) {
                min = "0" + min
            }

            hours = t.getHours() % 12

            var ampm = "pm";
            if (t.getHours() < 12) { ampm = "am"; }

            return hours + ":" + min + " " + ampm
		}

        function getTrack(trip) {
            for (var i=1; i<departures_data.query.results.row.length; i++) {
                if (departures_data.query.results.row[i].col2 == trip) {
                    return departures_data.query.results.row[i].col6;
                }
            }
            return "";
        }

		function getDepartureTime(trip) {
			// Check departure board for the time
            for (var i=1; i<departures_data.query.results.row.length; i++) {
                if (departures_data.query.results.row[i].col2 == trip) {
                    return new Date(departures_data.query.results.row[i].col0 * 1000);
                }
            }

			// Not on departure board at North Station or South Station, so instead, check the first stop time
			//if (myPage.trips[trip].stops.length > 0)
			//	return myPage.trips[trip].stops[0].scheduled;

			// couldn't find it anywhere
            return "";
		}

    </script>

</head>

<body>

	<script type="text/template" id="loggerWindowTemplate">
        <div class="loggerWindow">
            <h2>{0}</h2>
            <textarea id="{1}" rows="10" cols="200" readonly class="loggerData"></textarea>
        </div>
    </script>

    <div>
        <h1>MBTA Commuter Rail</h1>
        <div id="trips">

        </div>
    </div>

    <div id="jsonp_script_parent"></div>

    <script language="javascript" type="text/javascript">

          function init() {

                // setup jsonp yahoo bouncer for train schedule feed
				var script = document.createElement("script");
				// lowell src
				script.src = 'http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20json%20where%20url%3D%22http%3A%2F%2Fdeveloper.mbta.com%2Flib%2FRTCR%2FRailLine_10.json%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=grab_schedule';
				// or for fitchburg...
				// 	script.src = 'http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20json%20where%20url%3D%22http%3A%2F%2Fdeveloper.mbta.com%2Flib%2FRTCR%2FRailLine_9.json%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=grab_schedule';
				document.getElementById("jsonp_script_parent").appendChild(script);

				// setup jsonp yahoo bouncer for departure board feed
				var script2 = document.createElement("script");
				// http://developer.mbta.com/lib/gtrtfs/Departures.csv
				script2.src = 'http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20csv%20where%20url%3D%22http%3A%2F%2fdeveloper.mbta.com%2Flib%2Fgtrtfs%2FDepartures.csv%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=grab_departureboard';
				document.getElementById("jsonp_script_parent").appendChild(script2);
          }

          window.addEventListener("load", init, false);

    </script>

</body>
</html>
